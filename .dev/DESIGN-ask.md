# ask.ts 설계

## 두 가지 모드

### 1. Parallel 모드 (기본)
모든 AI에게 동시 질문 → 각각 응답 수집

```bash
bun .dev/ask.ts "질문"
```

### 2. Orchestrator 모드 (토론)
중앙 AI가 발언권 조율 → 자유 토론

```bash
bun .dev/ask.ts --debate "질문"
```

---

## 설정 파일

```yaml
# .dev/config.yaml

orchestrator:
  ai: claude          # Orchestrator로 사용할 AI

participants:         # 토론 참여 AI 목록
  - claude
  - gemini
  - codex

settings:
  max_rounds: 10      # 최대 라운드
  timeout: 300        # 타임아웃 (초)
```

---

## Orchestrator 토론 흐름

### 전체 구조

```
┌─────────────────────────────────────────────────┐
│                    User                          │
│                  "질문"                          │
└─────────────────────┬───────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────┐
│              Orchestrator (AI)                   │
│         설정된 AI가 중앙에서 조율                 │
│                                                 │
│  - 발언권 요청 수집                              │
│  - 상황 판단하여 발언자 선택                     │
│  - 대화 흐름 관리                               │
│  - 합의 도달 판단                               │
└─────────────────────┬───────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────┐
│              Participants (AI들)                 │
│         Claude | Gemini | Codex                 │
│                                                 │
│  - 발언권 요청 (REQUEST/PASS)                   │
│  - 선택되면 발언                                │
│  - 다른 AI 의견에 반응                          │
└─────────────────────────────────────────────────┘
```

### 단계별 흐름

```
[1] 유저 질문
    ↓
[2] Orchestrator → 모든 Participant에게: "발언권 요청하세요"
    ↓
[3] 각 Participant 응답: REQUEST 또는 PASS
    ↓
[4] Orchestrator가 상황 판단하여 발언자 선택
    (수치 공식 X, AI의 판단)
    ↓
[5] 선택된 AI에게: "발언하세요"
    ↓
[6] 해당 AI 발언
    ↓
[7] Orchestrator가 발언 내용을 모든 AI에게 공유
    ↓
[8] 2번으로 돌아감 (합의 도달 또는 종료 조건까지)
```

---

## 프롬프트 설계

### Orchestrator 시스템 프롬프트

```
당신은 AI 토론의 진행자(Orchestrator)입니다.

역할:
- 참여 AI들의 발언권 요청을 받아 적절히 조율
- 한 번에 한 AI만 발언하도록 관리
- 발언권이 특정 AI에게 몰리지 않도록 분배
- 토론 흐름을 자연스럽게 유지
- 합의 도달 여부 판단

참여 AI: {participants}

발언자 선택 시 고려사항:
- 아직 발언 기회가 적었던 AI
- 현재 주제와 관련 있어 보이는 AI
- 반론이나 새로운 관점을 제시할 것 같은 AI
- 직전 발언자는 가급적 피함

응답 형식:
- 발언자 선택: SELECT: {ai_name}
- 토론 종료: END: {결론 요약}
```

### Participant 발언권 요청 프롬프트

```
현재 토론:
주제: {topic}
지금까지 대화:
{conversation_history}

발언권을 요청하시겠습니까?

응답:
- REQUEST - 할 말이 있음
- PASS - 지금은 패스
```

### Participant 발언 프롬프트

```
현재 토론:
주제: {topic}
지금까지 대화:
{conversation_history}

발언권이 주어졌습니다. 의견을 말씀해주세요.
(다른 AI 의견에 동의/반박/보충 가능)
```

---

## 예시 시나리오

```
┌─────────────────────────────────────────────────┐
│ [User]                                          │
│ 이 서비스 아키텍처 어떻게 구성할까?              │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ [Orchestrator]                                  │
│ 유저가 아키텍처 구성에 대해 질문했습니다.        │
│ 참여자들, 발언권을 요청해주세요.                 │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ 발언권 요청:                                    │
│ - Claude: REQUEST                               │
│ - Gemini: REQUEST                               │
│ - Codex: PASS                                   │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ [Orchestrator]                                  │
│ Claude와 Gemini가 발언을 원합니다.              │
│ 아키텍처 주제이므로 먼저 Gemini의 의견을         │
│ 들어보겠습니다.                                 │
│                                                 │
│ SELECT: Gemini                                  │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ [Gemini]                                        │
│ 현재 규모를 고려하면 모놀리식으로 시작하는 게    │
│ 좋을 것 같습니다. 너무 이른 마이크로서비스는     │
│ 오버엔지니어링이 될 수 있어요.                   │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ [Orchestrator]                                  │
│ Gemini가 모놀리식을 제안했습니다.               │
│ 다른 의견 있으신가요? 발언권을 요청해주세요.     │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ 발언권 요청:                                    │
│ - Claude: REQUEST                               │
│ - Codex: REQUEST                                │
│ - Gemini: PASS                                  │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ [Orchestrator]                                  │
│ Claude가 아까부터 발언을 원했으니               │
│ Claude에게 기회를 주겠습니다.                   │
│                                                 │
│ SELECT: Claude                                  │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ [Claude]                                        │
│ Gemini 의견에 동의합니다. 다만 모듈러 모놀리스  │
│ 패턴을 적용하면 나중에 분리하기 쉬울 것 같아요. │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ [Orchestrator]                                  │
│ Claude가 모듈러 모놀리스를 제안했습니다.        │
│ Codex도 발언을 원했는데, 의견 있으신가요?       │
│                                                 │
│ SELECT: Codex                                   │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ [Codex]                                         │
│ 두 분 의견 모두 동의합니다.                     │
│ 모듈러 모놀리스가 테스트하기도 편할 것 같아요.  │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ [Orchestrator]                                  │
│ 모든 참여자가 모듈러 모놀리스에 동의했습니다.   │
│                                                 │
│ END: 모듈러 모놀리스 패턴 채택                  │
│ - 현재 규모에 적합                              │
│ - 추후 마이크로서비스 분리 용이                 │
│ - 테스트 편의성                                 │
└─────────────────────────────────────────────────┘
```

---

## 출력 형식

### 실시간 TUI

```
┌─────────────────────────────────────────────────┐
│ ask --debate              Orchestrator: Claude  │
├─────────────────────────────────────────────────┤
│                                                 │
│ [You] 이 아키텍처 어떻게 구성할까?               │
│                                                 │
│ [O] 발언권 요청 중...                           │
│     Claude: ✋  Gemini: ✋  Codex: 💤           │
│     → Gemini 선택                               │
│                                                 │
│ [Gemini] 🎤                                     │
│ 현재 규모를 고려하면 모놀리식으로...             │
│                                                 │
│ [O] 발언권 요청 중...                           │
│     Claude: ✋  Codex: ✋  Gemini: 💤           │
│     → Claude 선택                               │
│                                                 │
│ [Claude] 🎤                                     │
│ 동의합니다. 모듈러 모놀리스 패턴을...            │
│                                                 │
├─────────────────────────────────────────────────┤
│ 📋 합의: 모듈러 모놀리스                         │
└─────────────────────────────────────────────────┘
```

---

## CLI 인터페이스

### 질문 입력 방식

```bash
# 1. CLI 인라인
bun .dev/ask.ts "질문 내용"

# 2. 파일 기반
bun .dev/ask.ts --file question.md

# 3. stdin (파이프)
cat question.md | bun .dev/ask.ts

# 4. 여러 파일 컨텍스트와 함께
bun .dev/ask.ts --file question.md --context src/index.ts --context src/utils.ts
```

### 질문 파일

자유 형식. 파일 내용 전체가 질문으로 전달됨.

```
# question.txt (또는 .md, 아무 확장자)

이 아키텍처 어떻게 구성할까?
현재 유저 수는 1000명이고 팀은 3명이야.
```

### 모드 옵션

```bash
# Parallel 모드 (기본)
bun .dev/ask.ts "질문"

# Debate 모드
bun .dev/ask.ts --debate "질문"
bun .dev/ask.ts -d "질문"

# Orchestrator AI 지정
bun .dev/ask.ts --debate --orchestrator gemini "질문"

# 참여 AI 지정
bun .dev/ask.ts --debate --participants claude,codex "질문"

# 설정 파일 사용
bun .dev/ask.ts --config .dev/config.yaml "질문"
```

### 출력 옵션

```bash
# 기본 (TUI)
bun .dev/ask.ts "질문"

# JSON 출력
bun .dev/ask.ts --json "질문"

# 결과를 파일로 저장
bun .dev/ask.ts --output result.md "질문"

# 조용한 모드 (결과만)
bun .dev/ask.ts --quiet "질문"
```

---

## TODO

- [ ] .dev/config.yaml 스키마 정의
- [ ] lib/orchestrator.ts - Orchestrator 로직
- [ ] lib/participant.ts - Participant 로직
- [ ] ask.ts parallel 모드
- [ ] ask.ts debate 모드
